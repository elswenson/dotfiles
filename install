#!/usr/bin/env bash

DIR=$(cd "$(dirname "$0")" && pwd)
NODE_VERSION=22.18.0
NVM_VERSION=0.39.3
NVM_DIR="${NVM_DIR:-$HOME/.nvm}"


### NVM

function load_nvm(){
	# if NVM_DIR is already set, use that otherwise set it to ~/.nvm
	if [ -z "$NVM_DIR" ]; then
		export NVM_DIR="$HOME/.nvm"
	fi

	if [ -s "$NVM_DIR/nvm.sh" ]; then
		\. "$NVM_DIR/nvm.sh"
	fi

	if [ -s "$NVM_DIR/bash_completion" ]; then
		\. "$NVM_DIR/bash_completion"
	fi
}

### OH MY ZSH

function setup_oh_my_zsh() {
	if [ -d ~/.oh-my-zsh ]; then
			echo "Oh my zsh is already installed"
	else
	  echo "Installing Oh My Zsh..."
		sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
	fi
	mkdir -p ~/.zsh/completions
	setup_oh_my_zsh_plugins
}

function setup_oh_my_zsh_plugins() {
	# Keep plugin setup intentionally minimal for now.
	return 0
}

### APT PACKAGES
function install_apt_packages() {
	sudo apt-get update
}

function ensure_stow() {
	if command -v stow >/dev/null 2>&1; then
		return 0
	fi

	if [[ $OSTYPE == 'linux-gnu'* ]]; then
		sudo apt-get update
		sudo apt-get install -y stow
		return 0
	fi

	echo "stow is required but not installed"
	return 1
}

function install_npm_globals() {
	npm i -g @anthropic-ai/claude-code
}

if [ ! -s "$NVM_DIR/nvm.sh" ]; then
	PROFILE=/dev/null bash -c "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v$NVM_VERSION/install.sh | bash"
fi


### PRIMARY SETUP

load_nvm

echo "Symlinking dotfiles..."
ensure_stow

# if ~/.zshrc exists, delete it
if [ -f ~/.zshrc ]; then
	rm ~/.zshrc
fi

# Run stow to symlink dotfiles
bash "$DIR/stow.sh"
setup_oh_my_zsh


echo "Installing node..."

nvm install "$NODE_VERSION"
nvm alias default "$NODE_VERSION"


echo "Installing npm globals..."

install_npm_globals


echo "Done!"